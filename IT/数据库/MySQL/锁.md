# MySQL中的锁

## 一、查看锁

MySQL 5.7:

```sql
select * from information_schema.innodb_locks;
select * from information_schema.innodb_lock_waits;
select * from sys.innodb_lock_waits;
```

*note: RR级别，win10环境下测试，发现只有一条事务查询的时候，查不到锁记录，但是再启动一条事务进行查询，会发现两条锁记录，持有者分别是这两个事务，但是第二个事务会等待锁。*

MySQL 8.0:

```sql
select * from performance_schema.innodb_locks;
select * from performance.innodb_lock_waits;
select * from sys.innodb_lock_waits;
```



## 二、库级锁

FTWRL(Flush table with read lock）

## 三、表级锁

### MDL：metadata lock

执行DML时会加MDL读锁，执行DDL时加写锁。

写锁优先级高于读锁。

### 表锁(lock tables with lock)

## 四、行级锁

行锁

间隙锁

next-key lock

### 加锁规则

* 加锁的基本单位是next-key lock;
* 只有访问到的对象需要加锁；
* 索引上等值查询，给唯一索引退化为行锁（如果不存在满足条件的记录不会退化）；
* 索引上等值查询，向右遍历且最后一个值不满足条件时退化为间隙锁；
* 唯一索引上的范围查询会访问到不满足条件的第一个值为止。

## 四、两阶段锁协议

查询时加锁，直到事务提交时才会释放锁。